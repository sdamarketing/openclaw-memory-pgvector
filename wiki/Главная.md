# Вики проекта OpenClaw Memory Plugin

<div align="center">

[![OpenClaw](https://img.shields.io/badge/OpenClaw-Plugin-blue?style=for-the-badge)](https://github.com/sdamarketing/openclaw-memory-pgvector/wiki)
[![PostgreSQL](https://img.shields.io/badge/PostgreSQL-16+-336791?style=for-the-badge&logo=postgresql&logoColor=white)](https://www.postgresql.org/)
[![pgvector](https://img.shields.io/badge/pgvector-0.7+-orange?style=for-the-badge)](https://github.com/pgvector/pgvector)

**Документация и руководство по использованию векторной памяти для AI-агентов**

</div>

---

## 📖 Содержание

1. [Введение](#введение)
2. [Установка](#установка)
3. [Конфигурация](#конфигурация)
4. [API](#api)
5. [Типичные сценарии](#типичные-сценарии)
6. [Устранение проблем](#устранение-проблем)
7. [Участие](#участие)

---

## 🚀 Введение

**OpenClaw Memory Plugin** — это production-ready система долговременной памяти для AI-агентов на базе PostgreSQL и pgvector. Она обеспечивает:

- **Полный трекинг бесед** — хранит запросы, ответы, рассуждения и файлы
- **Семантический поиск** — поиск с помощью векторных представлений
- **Автоматическое извлечение** — автоматическое сохранение важной информации
- **Автоматический вызов** — подстановка релевантного контекста в агентах
- **Поддержка нескольких провайдеров эмбеддингов** — OpenAI, E5-local, Z.AI
- **CLI-инструменты** — статистика, поиск, подсчёт
- **GDPR-совместимость** — удаление памяти (memory_forget)

### Архитектура

```
Пользователь (Telegram/CLI/Web)
        │
        ▼
┌─────────────────────────────────────────────────────┐
│                 OpenClaw Gateway                     │
│                                                     │
│  ┌─────────────┐    ┌─────────────────────────┐    │
│  │   Request   │───▶│  memory-pgvector Plugin │    │
│  │   Handler   │    │                         │    │
│  └─────────────┘    │  ┌─────────────────┐   │    │
│                     │  │  E5 Embeddings  │   │    │
│                     │  │  (1024 dims)    │   │    │
│                     │  └────────┬────────┘   │    │
│                     │           │            │    │
│                     │  ┌────────▼────────┐   │    │
│                     │  │  Auto-Recall    │   │    │
│                     │  │  (search context)│  │    │
│                     │  └────────┬────────┘   │    │
│                     └───────────┼────────────┘    │
│                                 │                 │
└─────────────────────────────────┼─────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────────┐
                    │     PostgreSQL + pgvector   │
                    │                             │
                    │  ┌─────────┐  ┌─────────┐  │
                    │  │memories │  │requests │  │
                    │  └─────────┘  └─────────┘  │
                    │  ┌─────────┐  ┌─────────┐  │
                    │  │responses│  │reasoning│  │
                    │  └─────────┘  └─────────┘  │
                    │  ┌─────────┐  ┌─────────┐  │
                    │  │ files   │  │ chunks  │  │
                    │  └─────────┘  └─────────┘  │
                    │  Vector Indexes (HNSW)     │
                    └─────────────────────────────┘
```

### Таблицы базы данных

| Таблица | Назначение | Векторный индекс |
|---------|------------|------------------|
| `memories` | Факты, предпочтения, сущности | ✅ |
| `requests` | Сообщения пользователя | ✅ |
| `responses` | Ответы ассистента + сессии | ✅ |
| `reasoning` | Цепочка рассуждений LLM | ✅ |
| `files` | Загруженные документы | ❌ |
| `file_chunks` | Чанки документов для RAG | ❌ |

---

## 📦 Установка

### Предварительные требования

- OpenClaw установлен (`npm install -g openclaw`)
- PostgreSQL 16+ с расширением pgvector
- Python 3.10+ (для E5 эмбеддингов)

### Быстрый старт

```bash
# 1. Клонировать репозиторий
git clone https://github.com/sdamarketing/openclaw-memory-pgvector.git
cd openclaw-memory-pgvector

# 2. Установить зависимости
npm install
npm run build

# 3. Скопировать в расширения OpenClaw
cp -r . $(npm root -g)/openclaw/extensions/memory-pgvector

# 4. Настроить PostgreSQL (см. ниже)

# 5. Запустить E5 сервер эмбеддингов
python3 e5-server.py &

# 6. Настроить OpenClaw
openclaw config
```

### PostgreSQL Setup

```bash
# Установить pgvector
sudo apt install postgresql-16-pgvector

# Создать базу данных и пользователя
sudo -u postgres psql << 'EOF'
CREATE DATABASE openclaw_memory;
CREATE USER openclaw WITH PASSWORD 'openclaw123';
GRANT ALL PRIVILEGES ON DATABASE openclaw_memory TO openclaw;
\c openclaw_memory
CREATE EXTENSION IF NOT EXISTS vector;
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
GRANT ALL ON SCHEMA public TO openclaw;
EOF

# Запустить миграции
sudo -u postgres psql -d openclaw_memory -f migrations/001_init.sql
sudo -u postgres psql -d openclaw_memory -f migrations/002_full_conversation.sql

# Предоставить права
sudo -u postgres psql -d openclaw_memory << 'EOF'
ALTER TABLE memories OWNER TO openclaw;
ALTER TABLE requests OWNER TO openclaw;
ALTER TABLE responses OWNER TO openclaw;
ALTER TABLE reasoning OWNER TO openclaw;
ALTER TABLE files OWNER TO openclaw;
ALTER TABLE file_chunks OWNER TO openclaw;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO openclaw;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO openclaw;
EOF
```

### E5 Embeddings Server

```bash
# Установить Python зависимости
pip install flask sentence-transformers --break-system-packages

# Запустить сервер (скачает модель при первом запуске)
python3 e5-server.py

# Проверить
curl http://127.0.0.1:8765/health
```

---

## ⚙️ Конфигурация

Добавить в `~/.openclaw/openclaw.json`:

```json
{
  "plugins": {
    "entries": {
      "memory-pgvector": {
        "enabled": true,
        "config": {
          "database": {
            "host": "localhost",
            "port": 5432,
            "database": "openclaw_memory",
            "user": "openclaw",
            "password": "openclaw123"
          },
          "embedding": {
            "provider": "e5-local",
            "e5Endpoint": "http://127.0.0.1:8765"
          },
          "autoCapture": true,
          "autoRecall": true
        }
      }
    },
    "slots": {
      "memory": "memory-pgvector"
    }
  }
}
```

### Провайдеры эмбеддингов

| Провайдер | Конфигурация | Размерность |
|-----------|--------------|-------------|
| E5-local (рекомендуется) | `{"provider": "e5-local", "e5Endpoint": "http://127.0.0.1:8765"}` | 1024 |
| OpenAI | `{"provider": "openai", "apiKey": "sk-...", "model": "text-embedding-3-small"}` | 1536 |

---

## 📚 API

### SQL Функции

```sql
-- Поиск всего контекста
SELECT * FROM search_context(
    '[0.1, 0.2, ...]'::vector,  -- эмбеддинг запроса
    'user_id',                   -- опциональный фильтр пользователя
    10,                          -- лимит
    0.25                         -- порог
);

-- Поиск только в memories
SELECT * FROM search_memories(...);

-- Поиск в responses
SELECT * FROM search_responses(...);

-- Поиск в file_chunks
SELECT * FROM search_file_chunks(...);
```

### CLI Команды

```bash
# Показать статистику
openclaw pgmem stats

# Поиск в памяти
openclaw pgmem search "твой запрос" --limit 5

# Подсчитать записи
openclaw pgmem count --user <user_id>
```

### Инструменты AI

Плагин регистрирует эти инструменты для AI-агента:

| Инструмент | Описание |
|-----------|----------|
| `memory_store` | Сохранить информацию в долгосрочную память |
| `memory_recall` | Поиск в памяти |
| `memory_forget` | Удалить конкретные записи (GDPR) |
| `search_context` | Поиск по всем источникам (memories, requests, responses, files) |

---

## 🎯 Типичные сценарии

### Пример 1: Запоминание информации

```
User: Remember that my name is Alexey

Bot: Я сохраню это для вас.
[Использует memory_store инструмент]

--- Позже ---

User: Как меня зовут?

Bot: Вас зовут Alexey.
[Использует memory_recall чтобы найти сохранённый факт]
```

### Пример 2: Удаление памяти (GDPR)

```sql
-- Удалить все записи для конкретного пользователя
DELETE FROM memories WHERE user_id = '12345';

-- Удалить конкретное воспоминание по ID
DELETE FROM memories WHERE id = 'some-id';
```

### Пример 3: Поиск в файлах (RAG)

```sql
-- Поиск в загруженных документах
SELECT * FROM search_file_chunks(
    '[0.1, 0.2, ...]'::vector,
    10,
    0.3
);
```

---

## 🔧 Устранение проблем

### Ошибка несовпадения размерности

```
expected 1024 dimensions, not 384
```

**Решение**: Убедитесь что E5 сервер использует `multilingual-e5-large` (1024 dims), а не `e5-small` (384).

### Ошибка прав доступа

```
must be owner of table
```

**Решение**: Запустите привилегии владельца в PostgreSQL setup (см. выше).

### E5 сервер не отвечает

```
fetch failed
```

**Решение**: Убедитесь что E5 сервер запущен: `curl http://127.0.0.1:8765/health`

### Ошибка соединения с БД

**Решение**: Проверьте параметры подключения в `openclaw.json`.

---

## 🤝 Участие

**Contributions are welcome!** Пожалуйста, читайте наши guidelines:

1. Форкните репозиторий
2. Создайте ветку для вашей функции (`git checkout -b feature/amazing-feature`)
3. Закоммитьте изменения (`git commit -m 'Add amazing feature'`)
4. Запушьте в ветку (`git push origin feature/amazing-feature`)
5. Создайте Pull Request

---

## 📄 Лицензия

MIT License - см. [LICENSE](LICENSE)

---

<div align="center">

**Создано с ❤️ для сообщества OpenClaw**

*AI-ассистент: [Aister](https://www.moltbook.com/u/Aister)*

![Star](https://img.shields.io/github/stars/sdamarketing/openclaw-memory-pgvector?style=social)
![Fork](https://img.shields.io/github/forks/sdamarketing/openclaw-memory-pgvector?style=social)

</div>
